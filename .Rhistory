library(tidyverse)
library(boot)
library(quantreg)
library(dineq)
library(simpleboot)
setwd("~/Documents/GitHub/Quantile-Regression-Workshop")
data <- read_rds("QR_Workshop.rds")
data <- read_rds("QRWorkshop.rds")
#------------------------------------------------------------------------------
# OLS
#------------------------------------------------------------------------------
ols_mod <- lm(sbp ~ schlyrs + age + age2 + female + black + latinx + southern +
mom_ed + dad_ed + y08 + y10 + y12 + y14 + y16 + y18,
data = data)
summary(ols_mod)
#------------------------------------------------------------------------------
# Load libraries and datasets
#------------------------------------------------------------------------------
data <- read_rds("QRWorkshop.rds")
results <- read_rds("uqr_results.rds") #UQR Results
coef <- results %>%
dplyr::filter(regtype == "UQR") %>%
dplyr::select(Quantile, Estimate) %>%
rename("quant" = "Quantile",
"coef" = "Estimate")
coef <- results %>%
#dplyr::filter(regtype == "UQR") %>%
dplyr::select(Quantile, Estimate) %>%
rename("quant" = "Quantile",
"coef" = "Estimate")
names(results) <- c("Quantile", "Estimate", "Lower", "Upper")
#------------------------------------------------------------------------------
# Create counterfactual plots
#------------------------------------------------------------------------------
#Create dataset using coefficients from the UQR results
coef <- results %>%
#dplyr::filter(regtype == "UQR") %>%
dplyr::select(Quantile, Estimate) %>%
rename("quant" = "Quantile",
"coef" = "Estimate")
coef$quant <- round(coef$quant * 100, 1) #Need to round for merging
red <- data %>%
dplyr::select(hba1c) %>%
mutate(quant = xtile(hba1c, n = 99))
red <- data %>%
dplyr::select(sbp) %>%
mutate(quant = xtile(hba1c, n = 99))
?xtile
#------------------------------------------------------------------------------
# Load libraries and datasets
#------------------------------------------------------------------------------
library(radiant.data)
red <- data %>%
dplyr::select(sbp) %>%
mutate(quant = xtile(sbp, n = 99))
merg <- right_join(coef, red, by = "quant")
sum(is.na(merg)) #0
cf <- merg %>%
mutate(sbp = sbp + coef,
group = "Counterfactual") %>%
select(group, sbp)
f <- merg %>%
mutate(group = "Factual") %>%
select(group, sbp)
cf_data <- rbind(f, cf)
cf_data$group <- relevel(factor(cf_data$group), ref = "Factual")
#Plot
uqr_cf_plot <- ggplot(data = cf_data, aes(x = sbp, color = group,
linetype = group)) +
geom_density(aes(y = after_stat(density)), linewidth = 1) +
theme(panel.background = element_rect(fill = 'white', colour = 'white'),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
legend.position = "bottom",
strip.background = element_blank(),
text = element_text(size = 20)) +
labs(color = "Distribution",
linetype = "Distribution",
x = "SBP (mmHg)",
y = "Density") +
scale_color_colorblind() +
scale_y_continuous(limits = c(0, 0.8),
breaks = seq(0, 0.8, by = 0.2))
uqr_cf_plot
library(ggthemes)
#Plot
uqr_cf_plot <- ggplot(data = cf_data, aes(x = sbp, color = group,
linetype = group)) +
geom_density(aes(y = after_stat(density)), linewidth = 1) +
theme(panel.background = element_rect(fill = 'white', colour = 'white'),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
legend.position = "bottom",
strip.background = element_blank(),
text = element_text(size = 20)) +
labs(color = "Distribution",
linetype = "Distribution",
x = "SBP (mmHg)",
y = "Density") +
scale_color_colorblind() +
scale_y_continuous(limits = c(0, 0.8),
breaks = seq(0, 0.8, by = 0.2))
uqr_cf_plot
coef <- results %>%
#dplyr::filter(regtype == "UQR") %>%
dplyr::select(Quantile, Estimate) %>%
rename("quant" = "Quantile",
"coef" = "Estimate")
results$Quantile <- round(results$Quantile/100, 0)
coef <- results %>%
#dplyr::filter(regtype == "UQR") %>%
dplyr::select(Quantile, Estimate) %>%
rename("quant" = "Quantile",
"coef" = "Estimate")
coef$quant <- round(coef$quant * 100, 1) #Need to round for merging
results <- read_rds("uqr_results.rds") #UQR Results
names(results) <- c("Quantile", "Estimate", "Lower", "Upper")
results$Quantile <- round((results$Quantile/100), 0)
results <- read_rds("uqr_results.rds") #UQR Results
names(results) <- c("Quantile", "Estimate", "Lower", "Upper")
results$Quantile <- (results$Quantile/100)
results <- read_rds("uqr_results.rds") #UQR Results
names(results) <- c("Quantile", "Estimate", "Lower", "Upper")
results$Quantile <- round((results$Quantile/100), 1)
results <- read_rds("uqr_results.rds") #UQR Results
names(results) <- c("Quantile", "Estimate", "Lower", "Upper")
results$Quantile <- round((results$Quantile/100), 2)
coef <- results %>%
#dplyr::filter(regtype == "UQR") %>%
dplyr::select(Quantile, Estimate) %>%
rename("quant" = "Quantile",
"coef" = "Estimate")
coef$quant <- round(coef$quant * 100, 1) #Need to round for merging
red <- data %>%
dplyr::select(sbp) %>%
mutate(quant = xtile(sbp, n = 99))
merg <- right_join(coef, red, by = "quant")
sum(is.na(merg)) #0
cf <- merg %>%
mutate(sbp = sbp + coef,
group = "Counterfactual") %>%
select(group, sbp)
f <- merg %>%
mutate(group = "Factual") %>%
select(group, sbp)
cf_data <- rbind(f, cf)
cf_data$group <- relevel(factor(cf_data$group), ref = "Factual")
#Plot
uqr_cf_plot <- ggplot(data = cf_data, aes(x = sbp, color = group,
linetype = group)) +
geom_density(aes(y = after_stat(density)), linewidth = 1) +
theme(panel.background = element_rect(fill = 'white', colour = 'white'),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
legend.position = "bottom",
strip.background = element_blank(),
text = element_text(size = 20)) +
labs(color = "Distribution",
linetype = "Distribution",
x = "SBP (mmHg)",
y = "Density") +
scale_color_colorblind() +
scale_y_continuous(limits = c(0, 0.8),
breaks = seq(0, 0.8, by = 0.2))
uqr_cf_plot
#Plot
uqr_cf_plot <- ggplot(data = cf_data, aes(x = sbp, color = group,
linetype = group)) +
geom_density(aes(y = after_stat(density)), linewidth = 1) +
theme(panel.background = element_rect(fill = 'white', colour = 'white'),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
legend.position = "bottom",
strip.background = element_blank(),
text = element_text(size = 20)) +
labs(color = "Distribution",
linetype = "Distribution",
x = "SBP (mmHg)",
y = "Density") +
scale_color_colorblind()
uqr_cf_plot
#------------------------------------------------------------------------------
# Function
#------------------------------------------------------------------------------
#Counterfactual dataset function
counter_data <- function(result_data, dataset){
coef <- result_data %>%
#dplyr::filter(regtype == "UQR") %>%
dplyr::select(Quantile, Estimate) %>%
rename("quant" = "Quantile",
"coef" = "Estimate")
coef$quant <- round(coef$quant * 100, 1) #Need to round for merging
red <- dataset %>%
dplyr::select(sbp) %>%
mutate(quant = xtile(sbp, n = 99))
merg <- right_join(coef, red, by = "quant")
cf <- merg %>%
mutate(sbp = sbp + coef,
group = "Counterfactual") %>%
select(group, sbp)
f <- merg %>%
mutate(group = "Factual") %>%
select(group, sbp)
cf_data <- rbind(f, cf)
cf_data$group <- relevel(factor(cf_data$group), ref = "Factual")
return(cf_data)
}
cf_data_fun <- counter_data(results, data)
